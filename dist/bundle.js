!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";var e=function(e,t){e&&(e.style.display=t)},t=function(e,t,n){var s=document.createElement("span");return s.className=e,s.id=n,s.innerHTML=t,s},n=function(){var e=navigator.userAgent,t=e.indexOf("Android")>-1||e.indexOf("Adr")>-1,n=!!e.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),s=!t&&!n;return{isAndroid:t,isiOS:n,isPC:s,eventName:{mousedown:s?"mousedown":"touchstart",mouseup:s?"mouseup":"touchend",mousemove:s?"mousemove":"touchmove"}}},s=function(e,t){if(void 0===t&&(t="1"),e===document.body&&(e.className="_WM-0"),e.childNodes)for(var n=0;n<e.childNodes.length;n++){var i=e.childNodes[n];if(1===i.nodeType){["BR","HR","SCRIPT","BUTTON"].includes(i.nodeName)||(i.className=i.className?i.className+" _WM-"+t+"-"+n:"_WM-"+t+"-"+n),i.childNodes.length>0&&s(i,t+1+"-"+n)}}},i=function(e){var t=e.parentNode;if(t){var n=e.innerText,s=document.createTextNode(n);t.replaceChild(s,e);var i=s.previousSibling,r=s.nextSibling;i&&3===i.nodeType?(i.textContent=i.textContent+n,t.removeChild(s),r&&3===r.nodeType&&(i.textContent=i.textContent+r.textContent,t.removeChild(r))):r&&3===r.nodeType&&(s.textContent=s.textContent+r.textContent,t.removeChild(r))}},r=function(e){return document.getElementById(e)},o=["BUTTON","H1","H2","IMG"],a=function(e,t,n,s,i){this.id=e,this.childIndex=n,this.start=s,this.end=i,this.parentClassName=t||""},d=function(){function r(e){this.MARKED_CLASSNAME=e.markedClassName,this.TEMP_MARKED_CLASSNAME=e.selectedClassName,this.FOUCE_MARKED_CLASSNAME=e.focusMarkedClassName,this.options=e,this.btnWrapper=null,this.selectedText={},this.tempMarkDom=null,this.selectedMarkers={},this.hasTempDom=!1,this.currentId=null,this.isMarked=!1,this.pageY=0,this.touch=null,this.init()}return r.prototype.init=function(){var e=this.options.defaultMarkers;this.userAgent=n(),s(document.body),e&&Object.keys(e).length>0&&(this.selectedMarkers=e,this.setDefaultMarkers()),document.addEventListener("selectionchange",this.handleSelectionChange.bind(this)),document.addEventListener(this.userAgent.eventName.mousedown,this.handleMouseDown.bind(this)),this.userAgent.isPC&&document.addEventListener(this.userAgent.eventName.mouseup,this.handleMouseUp.bind(this))},r.prototype.handleSelectionChange=function(){if(!window.getSelection())throw new Error("不支持 window.getSelection 属性");if(this.selectedText=window.getSelection(),!this.isMarked){if(this.userAgent.isPC)return!this.checkNoSelectionText()||this.isMarked||this.hasTempDom?void(this.tempMarkDom&&this.tempMarkDom.className.indexOf(this.MARKED_CLASSNAME)):void this.hide();var e=this.selectedText.getRangeAt(0).commonAncestorContainer;this.checkNoSelectionText()&&!this.isMarked||!this.checkSelectionCount()||o.includes(e.parentNode.nodeName)?this.hide():this.selectedText.toString().length>0&&this.handleMouseUp()}},r.prototype.handleMouseDown=function(t){var n=this;this.userAgent.isPC?this.pageY=t.pageY:this.touch=t.touches[0];var s=document.getElementsByClassName(this.TEMP_MARKED_CLASSNAME)[0];s&&(i(s),this.hide());var r=t.target;if(r.className.indexOf(this.MARKED_CLASSNAME)>-1)return this.removeFocusStyle(),r.className=this.MARKED_CLASSNAME+" "+this.FOUCE_MARKED_CLASSNAME,e(document.getElementById(this.options.btnMarkID),"none"),e(document.getElementById(this.options.btnDeleteID),"block"),this.currentId=t.target.id,this.isMarked=!0,this.tempMarkDom=r,void setTimeout((function(){n.show()}),0);this.tempMarkDom=null,this.isMarked=!1,this.hide()},r.prototype.handleMouseUp=function(){var n=this;if(this.userAgent.isPC){if(this.checkNoSelectionText())return;setTimeout((function(){!n.checkNoSelectionText()||n.isMarked||n.hasTempDom||n.hide()}),0);var s=this.selectedText.getRangeAt(0).commonAncestorContainer;if(o.includes(s.parentNode.nodeName))return}var i=this.selectedText.getRangeAt(0).commonAncestorContainer;e(document.getElementById(this.options.btnMarkID),"block"),e(document.getElementById(this.options.btnDeleteID),"none");var r=this.selectedText,d=r.anchorOffset,l=r.focusOffset,h=Math.min(d,l),c=Math.max(d,l),u=i.parentNode.className.split(" "),m=u[u.length-1];if(this.tempMarkerInfo=new a((new Date).getTime().toString(),m,0,h,c),this.hasTempDom=!0,this.userAgent.isPC){var M=this.selectedText.toString(),p=this.selectedText.getRangeAt(0),g=t(this.TEMP_MARKED_CLASSNAME,M,this.tempMarkerInfo.id);p.surroundContents(g)}this.show()},r.prototype.hide=function(){if(e(this.btnWrapper,"none"),this.removeFocusStyle(),this.userAgent.isPC){var t=document.getElementsByClassName(this.TEMP_MARKED_CLASSNAME)[0];if(!t||t.className.indexOf(this.MARKED_CLASSNAME)>-1)return;i(t),this.hasTempDom=!1}else this.tempMarkDom=null},r.prototype.show=function(){this.btnWrapper||(this.btnWrapper=document.getElementById(this.options.btnWrapperID)),this.arrow||(this.arrow=document.getElementById(this.options.btnArrowID)),e(this.btnWrapper,"flex");var t=null,n=0,s=0,i=null;(i=this.tempMarkDom?this.tempMarkDom:document.getElementsByClassName(this.TEMP_MARKED_CLASSNAME)[0])&&(n=(t=i.getBoundingClientRect()).left+i.offsetWidth/2,t.width+t.left>window.innerWidth&&(n=t.left+5),s=t.top),n=Math.min(window.innerWidth-30,Math.max(10,n-15)),this.userAgent.isPC?(this.btnWrapper.style.top=s+window.scrollY-50+"px",this.arrow.style.left=n+"px"):(s=i?s+window.scrollY-50:this.touch.pageY-80,n=i?n:this.touch.pageX,this.btnWrapper.style.top=s+"px",this.arrow.style.left=n+"px")},r.prototype.resetMarker=function(e){for(var t=document.getElementsByClassName(e)[0],n=[],s=0,i=function(i){var o=t.childNodes[i];"#text"===o.nodeName&&(s=o.textContent.length);var d=i-1;r.selectedMarkers[e].forEach((function(e){t.childNodes[i].id==e.id&&n.push(new a(e.id,"",d,s,s+o.textContent.length))}))},r=this,o=0;o<t.childNodes.length;o++)i(o);n.length>0?this.selectedMarkers[e]=n:delete this.selectedMarkers[e]},r.prototype.setDefaultMarkers=function(){var e=this,n=this.selectedMarkers;Object.keys(n).forEach((function(s){var i=document.getElementsByClassName(s)[0];i&&n[s].forEach((function(n){var s=i.childNodes[n.childIndex];s.splitText(n.start);var r=s.nextSibling;r.splitText(n.end-n.start);var o=t(e.MARKED_CLASSNAME,r.textContent,n.id);i.replaceChild(o,r)}))}))},r.prototype.checkSelectionCount=function(){return this.selectedText.getRangeAt(0).endContainer===this.selectedText.getRangeAt(0).startContainer},r.prototype.checkNoSelectionText=function(){return 0===this.selectedText.toString().length||!this.selectedText.getRangeAt},r.prototype.removeFocusStyle=function(){var e=document.getElementsByClassName(this.FOUCE_MARKED_CLASSNAME)[0];e&&(e.className=this.MARKED_CLASSNAME)},r.prototype.mark=function(){if(this.tempMarkerInfo){var e=this.tempMarkerInfo.parentClassName;if(this.userAgent.isPC){document.getElementsByClassName(this.TEMP_MARKED_CLASSNAME)[0].className=this.MARKED_CLASSNAME}else{var n=this.selectedText.toString(),s=this.selectedText.getRangeAt(0),i=t(this.MARKED_CLASSNAME,n,this.tempMarkerInfo.id);s.surroundContents(i)}this.selectedMarkers[e]?this.selectedMarkers[e].push(this.tempMarkerInfo):this.selectedMarkers[e]=[this.tempMarkerInfo],this.currentId=this.tempMarkerInfo.id,this.tempMarkerInfo=null,this.resetMarker(e),this.selectedText.removeAllRanges(),this.hide()}},r.prototype.del=function(){if(this.currentId){this.tempMarkDom=null;var e=document.getElementById(this.currentId),t=e.parentNode.className.split(" "),n=t[t.length-1];i(e),this.resetMarker(n)}},r.prototype.getCurrentId=function(){return this.currentId},r.prototype.getAllMarkes=function(){return this.selectedMarkers},r}();window.addEventListener("load",(function(){var e,t,s;function i(e){var t=document.getElementById("debug");t.innerHTML=t.innerHTML+"<br />"+e}(e=document.createElement("div")).id="webMarkerBtnBox",e.style.display="none",e.innerHTML='<div>\n        <div id="webMarker_arrow"></div>\n        <div id="webMarker_btn_mark">高亮</div>\n        <div id="webMarker_btn_notes">笔记</div>\n        <div id="webMarker_btn_discuss">讨论</div>\n        <div id="webMarker_btn_delete">移除</div>\n      </div>\n    ',document.body.appendChild(e),t="../META-INF/css/web-marker.css",(s=document.createElement("link")).rel="stylesheet",s.type="text/css",s.href=t,document.getElementsByTagName("head")[0].appendChild(s);var o=null,a={};n().isiOS?window.initView=function(e){i("initView: 调用成功, 返回数据:"+e),e.length>0&&(o=JSON.parse(e)),a=new d({defaultMarkers:o,markedClassName:"_web_marker",focusMarkedClassName:"_focus_web_marker",selectedClassName:"_temp_marker",btnWrapperID:"webMarkerBtnBox",btnArrowID:"webMarker_arrow",btnMarkID:"webMarker_btn_mark",btnDeleteID:"webMarker_btn_delete"}),i("初始化 WebMarker 成功")}:(window.jsObject&&window.jsObject.getCallBack?window.jsObject.getCallBack().length>0&&(o=JSON.parse(window.jsObject.getCallBack())):o=JSON.parse(localStorage.getItem("markers")),a=new d({defaultMarkers:o,markedClassName:"_web_marker",focusMarkedClassName:"_focus_web_marker",selectedClassName:"_temp_marker",btnWrapperID:"webMarkerBtnBox",btnArrowID:"webMarker_arrow",btnMarkID:"webMarker_btn_mark",btnDeleteID:"webMarker_btn_delete"}));var l=function(){var e=JSON.stringify(a.getAllMarkes());if(!a.userAgent.isAndroid||!window.jsObject)return a.userAgent.isiOS?(i("调用 Save 方法"),window.webkit.messageHandlers.Save.postMessage(e),void i("调用 Save 成功")):void localStorage.setItem("markers",e);window.jsObject.save(e)};window.handleMarkSuccess=function(){l()},window.webMarker=a,window.webMarker.save=l;var h=r("webMarker_btn_mark"),c=r("webMarker_btn_delete"),u=r("webMarker_btn_notes"),m=r("webMarker_btn_discuss"),M=n().eventName.mousedown;h.addEventListener(M,(function(){a.mark(),l()})),c.addEventListener(M,(function(){a.del(),l()})),u.addEventListener(M,(function(){a.mark();var e=a.getCurrentId();if(!a.userAgent.isAndroid||!window.jsObject)return a.userAgent.isiOS?(i("调用 Note 方法"),window.webkit.messageHandlers.Note.postMessage(e),void i("调用 Note 成功")):void console.log("笔记",e);window.jsObject.note(e)})),m.addEventListener(M,(function(){a.mark();var e=a.getCurrentId();if(!a.userAgent.isAndroid||!window.jsObject)return a.userAgent.isiOS?(i("调用 Discuss 方法"),window.webkit.messageHandlers.Discuss.postMessage(e),void i("调用 Discuss 成功")):void console.log("讨论",e);window.jsObject.discussion(e)}));document.getElementById("debug");i("等待APP调用 initView")}))}));
