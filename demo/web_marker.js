!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).web_marker=t()}(this,(function(){"use strict";var e=function(e,t){e&&(e.style.display=t)},t=function(e,t,n){var s=document.createElement("span");return s.className=e,s.id=n,s.innerHTML=t,s},n=function(e,t){if(void 0===t&&(t="1"),e===document.body&&(e.className="_WM-0"),e.childNodes)for(var s=0;s<e.childNodes.length;s++){var i=e.childNodes[s];if(1===i.nodeType){["BR","HR","SCRIPT","BUTTON"].includes(i.nodeName)||(i.className=i.className?i.className+" _WM-"+t+"-"+s:"_WM-"+t+"-"+s),i.childNodes.length>0&&n(i,t+1+"-"+s)}}},s=function(e){var t=e.parentNode;if(t){var n=e.innerText,s=document.createTextNode(n);t.replaceChild(s,e);var i=s.previousSibling,r=s.nextSibling;i&&3===i.nodeType?(i.textContent=i.textContent+n,t.removeChild(s),r&&3===r.nodeType&&(i.textContent=i.textContent+r.textContent,t.removeChild(r))):r&&3===r.nodeType&&(s.textContent=s.textContent+r.textContent,t.removeChild(r))}},i=["BUTTON","IMG"],r=function(e,t,n,s,i){this.id=e,this.childIndex=n,this.start=s,this.end=i,this.parentClassName=t||""},o=function(){function o(e){if(!e.btns||0===e.btns.length)throw new Error("请传入按钮选项");if(!e.btnWrapperID)throw new Error("请传入按钮节点ID: btnWrapperID");this.MARKED_CLASSNAME=e.markedClassName,this.TEMP_MARKED_CLASSNAME=e.selectedClassName,this.FOUCE_MARKED_CLASSNAME=e.focusMarkedClassName,this.options=e,this.btnWrapper=function(e,t,n){var s=document.createElement("div");s.className="web-marker-wrapper",s.id=t,document.body.appendChild(s);for(var i=function(t){var i=document.createElement("div"),r=e[t],o=r.label,a=r.event;i.className="web-marker-btn",i.innerHTML=o,s.appendChild(i),i.addEventListener("click",(function(){a&&a(),n.hide()}))},r=0;r<e.length;r++)i(r);return s}(e.btns,e.btnWrapperID,this),this.selectedText={},this.tempMarkDom=null,this.selectedMarkers={},this.hasTempDom=!1,this.currentId=null,this.isMarked=!1,this.pageY=0,this.touch=null,this.init()}return o.prototype.init=function(){var e,t,s,i,r=this.options,o=r.defaultMarkers;r.disabledDom,this.userAgent=(e=navigator.userAgent,t=e.indexOf("Android")>-1||e.indexOf("Adr")>-1,s=!!e.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),{isAndroid:t,isiOS:s,isPC:i=!t&&!s,eventName:{mousedown:i?"mousedown":"touchstart",mouseup:i?"mouseup":"touchend",mousemove:i?"mousemove":"touchmove"}}),n(document.body),o&&Object.keys(o).length>0&&(this.selectedMarkers=o,this.setDefaultMarkers()),document.addEventListener("selectionchange",this.handleSelectionChange.bind(this)),document.addEventListener(this.userAgent.eventName.mousedown,this.handleMouseDown.bind(this)),this.userAgent.isPC&&document.addEventListener(this.userAgent.eventName.mouseup,this.handleMouseUp.bind(this))},o.prototype.handleSelectionChange=function(){if(!window.getSelection())throw new Error("抱歉, 不支持 window.getSelection 方法");if(this.selectedText=window.getSelection(),!this.isMarked&&!this.userAgent.isPC){var e=this.selectedText.getRangeAt(0).commonAncestorContainer;this.checkNoSelectionText()&&!this.isMarked||!this.checkSelectionCount()||i.includes(e.parentNode.nodeName)?this.hide():this.selectedText.toString().length>0&&this.handleMouseUp()}},o.prototype.handleMouseDown=function(e){var t=this,n=e.pageY,i=e.touches,r=e.target;if(this.userAgent.isPC?this.pageY=n:this.touch=i[0],!(r.className.indexOf("web-marker-btn")>-1)){var o=document.getElementsByClassName(this.TEMP_MARKED_CLASSNAME)[0];if(o&&(s(o),this.hide()),r.className.indexOf(this.MARKED_CLASSNAME)>-1)return this.removeFocusStyle(),r.className=this.MARKED_CLASSNAME+" "+this.FOUCE_MARKED_CLASSNAME,this.currentId=e.target.id,this.isMarked=!0,this.tempMarkDom=r,void setTimeout((function(){t.show()}),0);this.tempMarkDom=null,this.isMarked=!1,this.hide()}},o.prototype.handleMouseUp=function(){var e=this;if(this.userAgent.isPC){if(this.checkNoSelectionText()||!this.checkSelectionCount())return;setTimeout((function(){!e.checkNoSelectionText()||e.isMarked||e.hasTempDom||e.hide()}),0);var n=this.selectedText.getRangeAt(0).commonAncestorContainer;if(i.includes(n.parentNode.nodeName))return}var s=this.selectedText.getRangeAt(0).commonAncestorContainer,o=this.selectedText,a=o.anchorOffset,h=o.focusOffset,d=Math.min(a,h),l=Math.max(a,h),c=s.parentNode.className.split(" "),u=c[c.length-1];if(this.tempMarkerInfo=new r((new Date).getTime().toString(),u,0,d,l),this.hasTempDom=!0,this.userAgent.isPC){var m=this.selectedText.toString(),p=this.selectedText.getRangeAt(0),f=t(this.TEMP_MARKED_CLASSNAME,m,this.tempMarkerInfo.id);p.surroundContents(f)}this.show()},o.prototype.hide=function(){if(e(this.btnWrapper,"none"),this.removeFocusStyle(),this.userAgent.isPC){var t=document.getElementsByClassName(this.TEMP_MARKED_CLASSNAME)[0];if(!t||t.className.indexOf(this.MARKED_CLASSNAME)>-1)return;s(t),this.hasTempDom=!1}else this.tempMarkDom=null},o.prototype.show=function(){this.btnWrapper||(this.btnWrapper=document.getElementById(this.options.btnWrapperID)),e(this.btnWrapper,"flex");var t=null,n=0,s=0,i=null;(i=this.tempMarkDom?this.tempMarkDom:document.getElementsByClassName(this.TEMP_MARKED_CLASSNAME)[0])&&(n=(t=i.getBoundingClientRect()).left+i.offsetWidth/2,t.width+t.left>window.innerWidth&&(n=t.left+5),s=t.top),n=window.innerWidth<=768?"1%":Math.min(window.innerWidth-30,Math.max(0,n)),this.userAgent.isPC?(this.btnWrapper.style.top=s+window.scrollY-40+"px",this.btnWrapper.style.left=n+"px"):(s=i?s+window.scrollY-40:this.touch.pageY-70,n=i?n:this.touch.pageX,this.btnWrapper.style.top=s+"px",this.btnWrapper.style.left="1%")},o.prototype.resetMarker=function(e){for(var t=document.getElementsByClassName(e)[0],n=[],s=0,i=function(i){var a=t.childNodes[i];"#text"===a.nodeName&&(s=a.textContent.length);var h=i-1;o.selectedMarkers[e].forEach((function(e){t.childNodes[i].id==e.id&&n.push(new r(e.id,"",h,s,s+a.textContent.length))}))},o=this,a=0;a<t.childNodes.length;a++)i(a);n.length>0?this.selectedMarkers[e]=n:delete this.selectedMarkers[e]},o.prototype.setDefaultMarkers=function(){var e=this,n=this.selectedMarkers;Object.keys(n).forEach((function(s){var i=document.getElementsByClassName(s)[0];if(i)try{n[s].forEach((function(n){var s=i.childNodes[n.childIndex];s.splitText(n.start);var r=s.nextSibling;r.splitText(n.end-n.start);var o=t(e.MARKED_CLASSNAME,r.textContent,n.id);i.replaceChild(o,r)}))}catch(e){throw Error("the text content is changed, please check!")}}))},o.prototype.checkSelectionCount=function(){return this.selectedText.getRangeAt(0).endContainer===this.selectedText.getRangeAt(0).startContainer},o.prototype.checkNoSelectionText=function(){return 0===this.selectedText.toString().length||!this.selectedText.getRangeAt},o.prototype.removeFocusStyle=function(){var e=document.getElementsByClassName(this.FOUCE_MARKED_CLASSNAME)[0];e&&(e.className=this.MARKED_CLASSNAME)},o.prototype.mark=function(){if(this.tempMarkerInfo){var e=this.tempMarkerInfo.parentClassName;if(this.userAgent.isPC){document.getElementsByClassName(this.TEMP_MARKED_CLASSNAME)[0].className=this.MARKED_CLASSNAME}else{var n=this.selectedText.toString(),s=this.selectedText.getRangeAt(0),i=t(this.MARKED_CLASSNAME,n,this.tempMarkerInfo.id);s.surroundContents(i)}this.selectedMarkers[e]?this.selectedMarkers[e].push(this.tempMarkerInfo):this.selectedMarkers[e]=[this.tempMarkerInfo],this.currentId=this.tempMarkerInfo.id,this.tempMarkerInfo=null,this.resetMarker(e),this.selectedText.removeAllRanges(),this.hide()}},o.prototype.del=function(){if(this.currentId){this.tempMarkDom=null;var e=document.getElementById(this.currentId),t=e.parentNode.className.split(" "),n=t[t.length-1];s(e),this.resetMarker(n)}},o.prototype.getCurrentId=function(){return this.currentId},o.prototype.getAllMarkes=function(){return this.selectedMarkers},o.prototype.getSelectedText=function(){var e,t=this.selectedText.toString();if(!t){var n=(null===(e=this.tempMarkerInfo)||void 0===e?void 0:e.id)||this.getCurrentId();t=document.getElementById(n.toString()).innerHTML}return this.tempMarkerInfo=null,t},o}();return window.WebMarker=o,o}));
